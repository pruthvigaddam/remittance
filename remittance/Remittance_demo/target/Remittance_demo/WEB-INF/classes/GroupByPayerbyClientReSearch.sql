SELECT
	CASE
		WHEN
			BTF.TRANS_TYPE_CD	=	?
		AND	BTF.DR_CR_FLAG		=	1
		THEN
			(BTF.TENDERED_AMOUNT*1)
		ELSE
			CASE
				WHEN
					BTF.TRANS_TYPE_CD	=	?
				AND	BTF.DR_CR_FLAG		=	2
				THEN
					(BTF.TENDERED_AMOUNT*-1)
			END
	END
			AS	PAYMENTAMOUNT
,	CASE
		WHEN
			BTF.TRANS_TYPE_CD	=	?
		AND	BTF.DR_CR_FLAG		=	1
		THEN
			(BTF.TRANS_TOTAL_AMOUNT*1)
		ELSE
			CASE
				WHEN
					BTF.TRANS_TYPE_CD	=	?
				AND	BTF.DR_CR_FLAG		=	2
				THEN
					(BTF.TRANS_TOTAL_AMOUNT*-1)
			END
	END		AS	ADJUSTAMOUNT
FROM
	BATCH_TRANS_FILE	BTF
JOIN
	ACCOUNT	A
ON
	A.ACCT_ID			=	BTF.AR_ACCOUNT_ID
AND	A.ACCT_TYPE_CD		=	?
AND	A.ACCT_SUB_TYPE_CD	IN	(?, ?)
AND	A.ACTIVE_IND		=	1
JOIN
	PFT_ACCT_RELTN	PAR
ON
	PAR.ACCT_ID				=	A.ACCT_ID
AND	PAR.PARENT_ENTITY_NAME	=	'ORGANIZATION'
AND	PAR.ACTIVE_IND			=	1
JOIN
	ORGANIZATION	O
ON
	O.ORGANIZATION_ID	=	PAR.PARENT_ENTITY_ID
WHERE
	BTF.BATCH_TRANS_ID		=	?
AND	BTF.ACTIVE_IND			=	1
AND	BTF.NONTRANS_FLAG		=	0
AND	BTF.AR_ACCOUNT_ID		>	0.0
AND	BTF.CORSP_ACTIVITY_ID	=	0.0
AND	BTF.DR_CR_FLAG			=	?
GROUP BY
	O.ORGANIZATION_ID
,	BTF.BATCH_TRANS_FILE_ID
,	BTF.TENDERED_AMOUNT
,	BTF.TRANS_TYPE_CD
,	BTF.DR_CR_FLAG
,	BTF.TRANS_TOTAL_AMOUNT
UNION
SELECT
	CASE
		WHEN
			BTF.TRANS_TYPE_CD	=	?
		AND	BTF.DR_CR_FLAG		=	1
		THEN
			(BTF.TENDERED_AMOUNT*1)
		ELSE
			CASE
				WHEN
					BTF.TRANS_TYPE_CD	=	?
				AND	BTF.DR_CR_FLAG		=	2
				THEN
					(BTF.TENDERED_AMOUNT*-1)
			END
	END
			AS	PAYMENTAMOUNT
,	CASE
		WHEN
			BTF.TRANS_TYPE_CD	=	?
		AND	BTF.DR_CR_FLAG		=	1
		THEN
			(BTF.TRANS_TOTAL_AMOUNT*1)
		ELSE
			CASE
				WHEN
					BTF.TRANS_TYPE_CD	=	?
				AND	BTF.DR_CR_FLAG		=	2
				THEN
					(BTF.TRANS_TOTAL_AMOUNT*-1)
			END
	END		AS	ADJUSTAMOUNT
FROM
	BATCH_TRANS_FILE	BTF
JOIN
	ACCOUNT	A
ON
	A.ACCT_ID		=	BTF.AR_ACCOUNT_ID
AND	(
		(
			A.ACCT_TYPE_CD		=	?
		AND	A.ACCT_SUB_TYPE_CD	=	?
		)
	OR	(
			A.ACCT_TYPE_CD	=	?
		)
	)
AND	A.ACTIVE_IND	=	1
JOIN
	ORGANIZATION	O
ON
	O.ORGANIZATION_ID	=	BTF.PARENT_ENTITY_ID
WHERE
	BTF.BATCH_TRANS_ID	=	?
AND	BTF.ACTIVE_IND		=	1
AND	BTF.NONTRANS_FLAG	=	0
AND	BTF.AR_ACCOUNT_ID	>	0.0
AND	BTF.SEQUENCE_NBR	=	BTF.RELATED_SEQ_NBR
AND	BTF.DR_CR_FLAG		=	?
GROUP BY
	O.ORGANIZATION_ID
,	BTF.BATCH_TRANS_FILE_ID
,	BTF.TENDERED_AMOUNT
,	BTF.TRANS_TYPE_CD
,	BTF.DR_CR_FLAG
,	BTF.TRANS_TOTAL_AMOUNT
UNION
SELECT
	CASE
		WHEN
			BTF.TRANS_TYPE_CD	=	?
		AND	BTF.DR_CR_FLAG		=	1
		THEN
			(BTF.TRANS_TOTAL_AMOUNT*1)
		ELSE
			CASE
				WHEN
					BTF.TRANS_TYPE_CD	=	?
				AND	BTF.DR_CR_FLAG		=	2
				THEN
					(BTF.TRANS_TOTAL_AMOUNT*-1)
			END
	END
						AS	PAYMENTAMOUNT
,	CASE
		WHEN
			BTF.TRANS_TYPE_CD	=	?
		AND	BTF.DR_CR_FLAG		=	1
		THEN
			(BTF.TRANS_TOTAL_AMOUNT*1)
		ELSE
			CASE
				WHEN
					BTF.TRANS_TYPE_CD	=	?
				AND	BTF.DR_CR_FLAG		=	2
				THEN
					(BTF.TRANS_TOTAL_AMOUNT*-1)
			END
	END					AS	ADJUSTAMOUNT
FROM
	BATCH_TRANS_FILE	BTF
JOIN
	BILL_REC	BR
ON
	BR.CORSP_ACTIVITY_ID	=	BTF.CORSP_ACTIVITY_ID
AND	BR.BILL_CLASS_CD		=	?
AND	BR.ACTIVE_IND			=	1
JOIN
	BILL_RELTN	BRN
ON
	BRN.CORSP_ACTIVITY_ID	=	BR.CORSP_ACTIVITY_ID
AND	BRN.BILL_VRSN_NBR		=	BR.BILL_VRSN_NBR
AND	BRN.PARENT_ENTITY_NAME	=	'ACCOUNT'
AND	BRN.ACTIVE_IND			=	1
AND	BRN.BEG_EFFECTIVE_DT_TM	<=	?
AND	BRN.END_EFFECTIVE_DT_TM	>	?
JOIN
	ACCOUNT	A
ON
	A.ACCT_ID			=	BRN.PARENT_ENTITY_ID
AND	A.ACCT_TYPE_CD		=	?
AND	A.ACCT_SUB_TYPE_CD	IN	(?, ?)
AND	A.ACTIVE_IND		=	1
JOIN
	PFT_ACCT_RELTN	AOR
ON
	AOR.ACCT_ID				=	A.ACCT_ID
AND	AOR.PARENT_ENTITY_NAME	=	'ORGANIZATION'
AND	AOR.ROLE_TYPE_CD		=	?
AND	AOR.ACTIVE_IND			=	1
JOIN
	ORGANIZATION	O
ON
	O.ORGANIZATION_ID	=	AOR.PARENT_ENTITY_ID
AND	O.ACTIVE_IND		=	1
WHERE
	BTF.BATCH_TRANS_ID		=	?
AND	BTF.ACTIVE_IND			=	1
AND	BTF.NONTRANS_FLAG		=	0
AND	BTF.CORSP_ACTIVITY_ID	>	0.0
AND	BTF.DR_CR_FLAG			=	?
GROUP BY
	BTF.TENDERED_AMOUNT
,	BTF.TRANS_TYPE_CD
,	BTF.DR_CR_FLAG
,	BTF.TRANS_TOTAL_AMOUNT